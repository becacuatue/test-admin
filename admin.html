<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Admin ‚Äì Product Manager</title>
<link rel="stylesheet" href="style.css">
</head>

<body>

<h2>ADMIN ‚Äì UPLOAD S·∫¢N PH·∫®M</h2>

<div class="section">
  <div id="dropzone">K√©o th·∫£ ·∫£nh (t·ªëi ƒëa 10)</div>
  <div id="preview" class="preview"></div>
  <input
    type="file"
    id="fileInput"
    accept="image/*"
    multiple
    style="display:none"
  />

  <button type="button" id="btnUploadMobile">
    üì∑ Ch·ªçn / Ch·ª•p ·∫£nh
  </button>
</div>

<div class="section">
  <input id="pid" placeholder="ID s·∫£n ph·∫©m">
  <input id="pname" placeholder="T√™n s·∫£n ph·∫©m">
  <input id="price" type="number" placeholder="Gi√°">
</div>

<div class="section">
  <h4>Brand</h4>
  <input placeholder="Nh·∫≠p brand v√† Enter"
         onkeydown="addOption(event,'brandBox')">
  <div id="brandBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Tags</h4>
  <input placeholder="Nh·∫≠p tag v√† Enter"
         onkeydown="addOption(event,'tagBox')">
  <div id="tagBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Subtags</h4>
  <input placeholder="Nh·∫≠p subtag v√† Enter"
         onkeydown="addOption(event,'subtagBox')">
  <div id="subtagBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Size</h4>
  <input placeholder="Nh·∫≠p size v√† Enter"
         onkeydown="addOption(event,'sizeBox')">
  <div id="sizeBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Materials</h4>

  <div id="materialInputs"></div>

  <button onclick="addMaterialRow()" type="button">
    + Th√™m v·∫≠t li·ªáu
  </button>
</div>
<div class="section">
  <h4>Ratings</h4>

  <label>ƒê·ªô b·ªÅn</label>
  <input id="rate_doben" type="number" step="0.1" placeholder="VD: 9">

  <label>Ch·∫•t l∆∞·ª£ng</label>
  <input id="rate_chatluong" type="number" step="0.1" placeholder="VD: 8.5">

  <label>T∆∞∆°ng ƒë·ªìng</label>
  <input id="rate_tuongdong" type="number" step="0.1" placeholder="VD: 8.25">

  <label>ƒê·ªô hi·∫øm</label>
  <input id="rate_dohiem" type="number" step="0.1" placeholder="VD: 7">
</div>



<div class="section">
  <textarea id="des" rows="4" placeholder="M√¥ t·∫£ s·∫£n ph·∫©m"></textarea>
</div>

<button class="primary" id="save">L∆ØU S·∫¢N PH·∫®M</button>

<script type="module">
  /* ================= MATERIAL INPUT ================= */

const materialBox = document.getElementById("materialInputs");

window.addMaterialRow = () => {
  const row = document.createElement("div");
  row.style.display = "flex";
  row.style.gap = "8px";
  row.style.marginBottom = "6px";

  row.innerHTML = `
    <input placeholder="T√™n v·∫≠t li·ªáu" style="flex:2">
    <input type="number" placeholder="%" style="flex:1">
    <button type="button">‚úï</button>
  `;

  row.querySelector("button").onclick = () => row.remove();

  materialBox.appendChild(row);
};
addMaterialRow();

function getMaterialsObject() {
  const materials = {};
  [...materialBox.children].forEach(row => {
    const [nameEl, percentEl] = row.querySelectorAll("input");
    const name = nameEl.value.trim();
    const percent = Number(percentEl.value);

    if (name && !isNaN(percent)) {
      materials[name] = percent;
    }
  });
  return materials;
}
function getRatingsObject() {
  return {
    "ƒê·ªô b·ªÅn": Number(document.getElementById("rate_doben").value) || 0,
    "Ch·∫•t L∆∞·ª£ng": Number(document.getElementById("rate_chatluong").value) || 0,
    "T∆∞∆°ng ƒë·ªìng": Number(document.getElementById("rate_tuongdong").value) || 0,
    "ƒê·ªô Hi·∫øm": Number(document.getElementById("rate_dohiem").value) || 0
  };
}
/* ================= FIREBASE ADMIN ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { 
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  setDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
import {
  getAuth,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-auth.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";

/* ===== CONFIG ===== */
const firebaseConfig = {
  apiKey: "AIzaSyBdEuAqxHxHaxE3lTCEOwH2YO8L2Jg4hlY",
  authDomain: "dtorder-19c91.firebaseapp.com",
  projectId: "dtorder-19c91",
  storageBucket: "dtorder-19c91.firebasestorage.app",
  messagingSenderId: "499125096462",
  appId: "1:499125096462:web:5fc0f37019e018fd57ac5f"
};

/* ===== INIT ===== */
const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
const storage = getStorage(app);

/* ===== ADMIN CHECK ===== */
let currentAdmin = null;

onAuthStateChanged(auth, (user) => {
  if (!user || user.email !== "becacuatue@gmail.com") {
    alert("B·∫°n kh√¥ng c√≥ quy·ªÅn admin");
    window.location.href = "admin_login.html";
    return;
  }

  currentAdmin = user;
  console.log("Admin logged in:", user.email);
});

/* ===== ADD DATA (Firestore) ===== */
export async function addProduct(data) {
  if (!currentAdmin) throw new Error("Ch∆∞a ƒëƒÉng nh·∫≠p admin");

  return await addDoc(collection(db, "products"), {
    ...data,
    createdBy: currentAdmin.uid,
    createdAt: serverTimestamp()
  });
}

/* ===== UPLOAD IMAGE (Storage) ===== */
export async function uploadImage(file) {
  if (!currentAdmin) throw new Error("Ch∆∞a ƒëƒÉng nh·∫≠p admin");

  const imageRef = ref(
    storage,
    `products/${currentAdmin.uid}/${Date.now()}_${file.name}`
  );

  await uploadBytes(imageRef, file);
  return await getDownloadURL(imageRef);
}


/* ================= TOGGLE UTILS ================= */
function createToggle(boxId, value) {
  const box = document.getElementById(boxId);
  if (!box) return;

  value = value.trim();
  if (!value) return;

  const exists = [...box.children]
    .some(el => el.dataset.value === value);
  if (exists) return;

  const btn = document.createElement("div");
  btn.className = "toggle";
  btn.textContent = value;
  btn.dataset.value = value;
  btn.onclick = () => btn.classList.toggle("active");

  box.appendChild(btn);
}

window.addOption = (e, boxId) => {
  if (e.key !== "Enter") return;
  e.preventDefault();
  createToggle(boxId, e.target.value);
  e.target.value = "";
};

function getSelected(boxId) {
  return [...document.querySelectorAll(`#${boxId} .toggle.active`)]
    .map(b => b.dataset.value);
}

/* ================= LOAD OPTIONS FROM DB ================= */
const uniq = arr => [...new Set(arr)];

async function loadOptions() {
  const snap = await getDocs(collection(db,"products"));

  let brands=[], tags=[], subtags=[], sizes=[], materials=[];

  snap.forEach(doc => {
    const p = doc.data();
    brands.push(...(p.brand||[]));
    tags.push(...(p.tags||[]));
    subtags.push(...(p.subtags||[]));
    sizes.push(...(p.size||[]));
    if (p.materials && typeof p.materials === "object" && p.materials.name) {
      materials.push(p.materials.name);
    }
  });

  uniq(brands).forEach(v=>createToggle("brandBox",v));
  uniq(tags).forEach(v=>createToggle("tagBox",v));
  uniq(subtags).forEach(v=>createToggle("subtagBox",v));
  uniq(sizes).forEach(v=>createToggle("sizeBox",v));
  uniq(materials).forEach(v=>createToggle("materialBox",v));
}
loadOptions();
/* ================= IMAGE DROP + SORT + DELETE ================= */
let files = [];

const dropzone = document.getElementById("dropzone");
const preview  = document.getElementById("preview");

dropzone.ondragover = e => e.preventDefault();

dropzone.ondrop = e => {
  e.preventDefault();

  const newFiles = [...e.dataTransfer.files]
    .filter(f => f.type.startsWith("image/"));

  for (const file of newFiles) {
    if (files.length >= 10) break;
    files.push(file);
  }

  renderPreview();
};

function renderPreview() {
  preview.innerHTML = "";

  files.forEach((file, index) => {
    const wrapper = document.createElement("div");
    wrapper.className = "img-box";
    wrapper.draggable = true;
    wrapper.dataset.index = index;

    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);

    const del = document.createElement("button");
    del.innerHTML = "‚úï";
    del.onclick = () => {
      files.splice(index, 1);
      renderPreview();
    };

    // drag sort
    wrapper.ondragstart = e => {
      e.dataTransfer.setData("from", index);
    };

    wrapper.ondragover = e => e.preventDefault();

    wrapper.ondrop = e => {
      e.preventDefault();
      const from = e.dataTransfer.getData("from");
      if (from == index) return;

      const moved = files.splice(from, 1)[0];
      files.splice(index, 0, moved);
      renderPreview();
    };

    wrapper.appendChild(img);
    wrapper.appendChild(del);
    preview.appendChild(wrapper);
  });
}
const fileInput = document.getElementById("fileInput");
const btnUploadMobile = document.getElementById("btnUploadMobile");

btnUploadMobile.onclick = () => {
  fileInput.click();
};

fileInput.onchange = () => {
  const selected = [...fileInput.files]
    .filter(f => f.type.startsWith("image/"));

  for (const file of selected) {
    if (files.length >= 10) break;
    files.push(file);
  }

  fileInput.value = "";
  renderPreview();
};



/* ================= SAVE PRODUCT ================= */
document.getElementById("save").onclick = async () => {
  document.getElementById("save").style.backgroundColor = "gray";
  const pidEl   = document.getElementById("pid");
  const nameEl  = document.getElementById("pname");
  const priceEl = document.getElementById("price");
  const desEl   = document.getElementById("des");

  const pid   = pidEl.value.trim();
  const name  = nameEl.value.trim();
  const price = Number(priceEl.value);

  if (!pid || !name || !price) {
    alert("Thi·∫øu th√¥ng tin c∆° b·∫£n");
    return;
  }

  const product = {
    id: pid,
    name: name,
    price: price,
    brand: getSelected("brandBox"),
    tags: getSelected("tagBox"),
    subtags: getSelected("subtagBox"),
    size: getSelected("sizeBox"),
    materials: getMaterialsObject(),
    ratings: getRatingsObject(),
    images: [],
    des: desEl.value,
    createdAt: new Date()
  };

  try {
    for (const f of files) {
      const rf = ref(
        storage,
        `products/${pid}/${Date.now()}_${f.name}`
      );
      const snap = await uploadBytes(rf, f);
      product.images.push(
        await getDownloadURL(snap.ref)
      );
    }

    await addDoc(collection(db, "products"), product);
    alert("L∆ØU TH√ÄNH C√îNG");
    location.reload();

  } catch (err) {
    console.error(err);
    alert("L·ªñI FIREBASE");
  }
};

</script>
</body>
</html>

