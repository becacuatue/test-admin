<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8" />
<title>Admin – Product Manager</title>

<style>
body { font-family: Arial; padding:20px; background:#f7f7f7 }
h2 { margin-bottom:10px }
.section { background:#fff; padding:15px; border-radius:8px; margin-bottom:15px }
button { padding:10px 14px; border-radius:6px; border:none; cursor:pointer }
button.primary { background:#111; color:#fff }
.toggle-group { display:flex; flex-wrap:wrap; gap:8px; margin-top:8px }
.toggle {
  padding:6px 14px;
  border:1px solid #ccc;
  border-radius:20px;
  cursor:pointer;
  background:#f5f5f5;
  user-select:none;
}
.toggle.active {
  background:#111;
  color:#fff;
  border-color:#111;
}
#dropzone {
  border:2px dashed #999;
  padding:30px;
  text-align:center;
  margin-bottom:10px;
}
.preview img {
  width:90px;
  border-radius:8px;
  margin-right:8px;
}
input, textarea { width:100%; padding:8px; margin-top:8px }
</style>
</head>

<body>

<h2>ADMIN – UPLOAD SẢN PHẨM</h2>

<div class="section">
  <div id="dropzone">Kéo thả ảnh (tối đa 10)</div>
  <div id="preview" class="preview"></div>
</div>

<div class="section">
  <input id="pid" placeholder="ID sản phẩm">
  <input id="pname" placeholder="Tên sản phẩm">
  <input id="price" type="number" placeholder="Giá">
</div>

<div class="section">
  <h4>Brand</h4>
  <input placeholder="Nhập brand và Enter"
         onkeydown="addOption(event,'brandBox')">
  <div id="brandBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Tags</h4>
  <input placeholder="Nhập tag và Enter"
         onkeydown="addOption(event,'tagBox')">
  <div id="tagBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Subtags</h4>
  <input placeholder="Nhập subtag và Enter"
         onkeydown="addOption(event,'subtagBox')">
  <div id="subtagBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Size</h4>
  <input placeholder="Nhập size và Enter"
         onkeydown="addOption(event,'sizeBox')">
  <div id="sizeBox" class="toggle-group"></div>
</div>

<div class="section">
  <h4>Materials</h4>

  <div id="materialInputs"></div>

  <button onclick="addMaterialRow()" type="button">
    + Thêm vật liệu
  </button>
</div>
<div class="section">
  <h4>Ratings</h4>

  <label>Độ bền</label>
  <input id="rate_doben" type="number" step="0.1" placeholder="VD: 9">

  <label>Chất lượng</label>
  <input id="rate_chatluong" type="number" step="0.1" placeholder="VD: 8.5">

  <label>Tương đồng</label>
  <input id="rate_tuongdong" type="number" step="0.1" placeholder="VD: 8.25">

  <label>Độ hiếm</label>
  <input id="rate_dohiem" type="number" step="0.1" placeholder="VD: 7">
</div>



<div class="section">
  <textarea id="des" rows="4" placeholder="Mô tả sản phẩm"></textarea>
</div>

<button class="primary" id="save">LƯU SẢN PHẨM</button>

<script type="module">
  /* ================= MATERIAL INPUT ================= */

const materialBox = document.getElementById("materialInputs");

window.addMaterialRow = () => {
  const row = document.createElement("div");
  row.style.display = "flex";
  row.style.gap = "8px";
  row.style.marginBottom = "6px";

  row.innerHTML = `
    <input placeholder="Tên vật liệu" style="flex:2">
    <input type="number" placeholder="%" style="flex:1">
    <button type="button">✕</button>
  `;

  row.querySelector("button").onclick = () => row.remove();

  materialBox.appendChild(row);
};
addMaterialRow();

function getMaterialsObject() {
  const materials = {};
  [...materialBox.children].forEach(row => {
    const [nameEl, percentEl] = row.querySelectorAll("input");
    const name = nameEl.value.trim();
    const percent = Number(percentEl.value);

    if (name && !isNaN(percent)) {
      materials[name] = percent;
    }
  });
  return materials;
}
function getRatingsObject() {
  return {
    "Độ bền": Number(document.getElementById("rate_doben").value) || 0,
    "Chất Lượng": Number(document.getElementById("rate_chatluong").value) || 0,
    "Tương đồng": Number(document.getElementById("rate_tuongdong").value) || 0,
    "Độ Hiếm": Number(document.getElementById("rate_dohiem").value) || 0
  };
}


/* ================= FIREBASE ================= */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-app.js";
import { getFirestore, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.10.0/firebase-storage.js";

const firebaseConfig = {
  apiKey: "AIzaSyBdEuAqxHxHaxE3lTCEOwH2YO8L2Jg4hlY",
  authDomain: "dtorder-19c91.firebaseapp.com",
  projectId: "dtorder-19c91",
  storageBucket: "dtorder-19c91.firebasestorage.app",
  messagingSenderId: "499125096462",
  appId: "1:499125096462:web:5fc0f37019e018fd57ac5f"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

/* ================= TOGGLE UTILS ================= */
function createToggle(boxId, value) {
  const box = document.getElementById(boxId);
  if (!box) return;

  value = value.trim();
  if (!value) return;

  const exists = [...box.children]
    .some(el => el.dataset.value === value);
  if (exists) return;

  const btn = document.createElement("div");
  btn.className = "toggle";
  btn.textContent = value;
  btn.dataset.value = value;
  btn.onclick = () => btn.classList.toggle("active");

  box.appendChild(btn);
}

window.addOption = (e, boxId) => {
  if (e.key !== "Enter") return;
  e.preventDefault();
  createToggle(boxId, e.target.value);
  e.target.value = "";
};

function getSelected(boxId) {
  return [...document.querySelectorAll(`#${boxId} .toggle.active`)]
    .map(b => b.dataset.value);
}

/* ================= LOAD OPTIONS FROM DB ================= */
const uniq = arr => [...new Set(arr)];

async function loadOptions() {
  const snap = await getDocs(collection(db,"products"));

  let brands=[], tags=[], subtags=[], sizes=[], materials=[];

  snap.forEach(doc => {
    const p = doc.data();
    brands.push(...(p.brand||[]));
    tags.push(...(p.tags||[]));
    subtags.push(...(p.subtags||[]));
    sizes.push(...(p.size||[]));
    (p.materials||[]).forEach(m=>materials.push(m.name));
  });

  uniq(brands).forEach(v=>createToggle("brandBox",v));
  uniq(tags).forEach(v=>createToggle("tagBox",v));
  uniq(subtags).forEach(v=>createToggle("subtagBox",v));
  uniq(sizes).forEach(v=>createToggle("sizeBox",v));
  uniq(materials).forEach(v=>createToggle("materialBox",v));
}
loadOptions();

/* ================= IMAGE DROP ================= */
let files=[];
const dropzone=document.getElementById("dropzone");
const preview=document.getElementById("preview");

dropzone.ondragover=e=>e.preventDefault();
dropzone.ondrop=e=>{
  e.preventDefault();
  files=[...e.dataTransfer.files].slice(0,10);
  preview.innerHTML="";
  files.forEach(f=>{
    const img=document.createElement("img");
    img.src=URL.createObjectURL(f);
    preview.appendChild(img);
  });
};

/* ================= SAVE PRODUCT ================= */
document.getElementById("save").onclick = async () => {

  const pidEl   = document.getElementById("pid");
  const nameEl  = document.getElementById("pname");
  const priceEl = document.getElementById("price");
  const desEl   = document.getElementById("des");

  const pid   = pidEl.value.trim();
  const name  = nameEl.value.trim();
  const price = Number(priceEl.value);

  if (!pid || !name || !price) {
    alert("Thiếu thông tin cơ bản");
    return;
  }

  const product = {
    id: pid,
    name: name,
    price: price,
    brand: getSelected("brandBox"),
    tags: getSelected("tagBox"),
    subtags: getSelected("subtagBox"),
    size: getSelected("sizeBox"),
    materials: getMaterialsObject(),
    ratings: getRatingsObject(),
    images: [],
    des: desEl.value,
    createdAt: new Date()
  };

  try {
    for (const f of files) {
      const rf = ref(
        storage,
        `products/${pid}/${Date.now()}_${f.name}`
      );
      const snap = await uploadBytes(rf, f);
      product.images.push(
        await getDownloadURL(snap.ref)
      );
    }

    await addDoc(collection(db, "products"), product);
    alert("LƯU THÀNH CÔNG");
    location.reload();

  } catch (err) {
    console.error(err);
    alert("LỖI FIREBASE");
  }
};

</script>
</body>
</html>

